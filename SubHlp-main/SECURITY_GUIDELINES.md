# セキュリティガイドライン - ログイン・新規登録機能

## 現在の実装とセキュリティ対策

### 実装済みのセキュリティ機能

1. **統一エラーメッセージ**
   - ユーザー存在の有無を判別できないよう、ログイン失敗時は統一メッセージを表示
   - `auth/user-not-found` と `auth/wrong-password` を同じメッセージに統一

2. **レート制限**
   - ログイン試行回数制限: 5回
   - ロックアウト時間: 15分
   - 3回失敗後にCAPTCHA認証を要求

3. **CAPTCHA認証**
   - 6文字の英数字CAPTCHA
   - 更新機能付き
   - フォントを等幅にして読みやすさを向上

4. **セキュリティ情報表示**
   - ログイン試行回数の可視化
   - 警告レベルの段階的表示

5. **SNSログインセキュリティ**
   - SNSログイン試行回数制限: 3回
   - SNSロックアウト時間: 10分
   - SNSログイン専用のエラーハンドリング
   - SNSログイン状態の可視化

## SNSログインのセキュリティ機能

### 実装内容
- **Google/Microsoftログイン**: 3回失敗で10分間ロックアウト
- **エラーメッセージ**: SNSログイン専用の日本語エラーメッセージ
- **状態管理**: SNSログイン試行回数とロックアウト状態の管理
- **UI表示**: SNSログインのセキュリティ情報を専用UIで表示

### SNSログインの特徴
- **ポップアップ認証**: ブラウザのポップアップを使用
- **外部認証**: Google/Microsoftの認証サーバーを使用
- **セッション管理**: Firebaseが自動的にセッションを管理
- **キャンセル処理**: ポップアップを閉じた場合の適切なエラーハンドリング

### セキュリティ上の利点
- **強力な認証**: Google/Microsoftの高度なセキュリティ機能を利用
- **2要素認証**: 既存のGoogle/Microsoftアカウントの2FAを活用
- **アカウント保護**: 外部プロバイダーによる不正アクセス検知
- **適切なエラー処理**: キャンセル時の誤った成功メッセージを防止

## 新規登録誘導に関する考察

### メリット
- **ユーザビリティの向上**: 既存ユーザーが新規登録画面を探す手間を削減
- **コンバージョン率の向上**: ログイン失敗時に新規登録への導線を提供
- **ユーザー体験の改善**: シームレスな認証フロー

### セキュリティリスク
- **ユーザー列挙攻撃**: 攻撃者が特定のメールアドレスが登録済みかを判別可能
- **ブルートフォース攻撃**: 登録済みアカウントを特定した後のパスワードクラッキング
- **情報収集**: 攻撃者が組織のメールアドレスパターンを収集

### 対策案

#### 1. 段階的開示アプローチ
```typescript
// 推奨実装例
const handleLoginError = (errorCode: string) => {
  switch (errorCode) {
    case "auth/user-not-found":
    case "auth/wrong-password":
      // セキュリティのため統一メッセージ
      return "メールアドレスまたはパスワードが正しくありません"
    case "auth/email-already-in-use":
      // 新規登録時のみ表示
      return "このメールアドレスは既に使用されています"
  }
}
```

#### 2. 条件付き新規登録誘導
- ログイン失敗回数が少ない場合のみ新規登録誘導を表示
- セキュリティ警告と併せて表示

#### 3. 代替案の提示
```typescript
// 推奨UI例
{loginAttempts <= 2 && (
  <div className="mt-3 text-center">
    <p className="text-xs text-gray-600">
      アカウントをお持ちでない方は
    </p>
    <Button variant="link" onClick={toggleMode}>
      アカウント作成はこちら
    </Button>
  </div>
)}
```

## 推奨セキュリティ設定

### Firebase Authentication設定
1. **パスワードポリシー**
   - 最小8文字
   - 大文字・小文字・数字・記号を含む
   - 一般的なパスワードの禁止

2. **レート制限**
   - 1分間に5回のログイン試行制限
   - 1時間に20回のログイン試行制限

3. **セッション管理**
   - セッションタイムアウト: 30分
   - 同時ログイン制限: 3デバイス

### 追加推奨機能
1. **2要素認証（2FA）** - 実装予定（無料プラン対応）
2. **ログイン履歴の記録** - 実装予定
3. **異常ログイン検知** - 実装予定
4. **IPアドレス制限** - 実装予定
5. **デバイス認証** - 実装予定

## 実装チェックリスト

- [x] 統一エラーメッセージの実装
- [x] レート制限の実装
- [x] セキュリティ情報の表示
- [x] SNSログインのレート制限
- [x] SNSログインのエラーハンドリング
- [x] SNSログイン状態の可視化
- [x] アカウント連携機能の実装
- [ ] 条件付き新規登録誘導の実装
- [ ] 多要素認証（TOTP）の実装 - 未実装
- [ ] ログイン履歴の記録 - 実装予定
- [ ] 異常ログイン検知の実装 - 実装予定

## 結論

新規登録誘導機能は、適切なセキュリティ対策と組み合わせることで、ユーザビリティとセキュリティの両立が可能です。現在の実装では基本的なセキュリティ対策を施していますが、さらなる改善として条件付き誘導の実装を推奨します。

## 現在のセキュリティレベル

### 無料プランでのセキュリティ機能
- ✅ **ログイン試行回数制限**: 5回でロックアウト
- ✅ **アカウントロックアウト**: 15分間
- ✅ **SNSログイン制限**: 3回で10分間ロックアウト
- ✅ **アカウント連携機能**: 安全な認証方法の統合
- 🔄 **多要素認証**: 未実装（TOTP認証で無料対応可能）

### 将来的なセキュリティ強化
- **Blaze Plan（有料）**: SMS認証による多要素認証
- **TOTP認証**: Google Authenticator等による無料多要素認証
- **ログイン履歴**: セキュリティ監査機能
- **異常検知**: AIによる不正アクセス検知 